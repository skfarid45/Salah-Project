<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Masjid Timings</title>

    <style>
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        max-width: 950px;
        margin: 20px auto;
        background: #f5f7fb;
        padding: 10px;
      }
      h1 {
        text-align: center;
        color: #1a4a7a;
        margin-bottom: 25px;
      }
      .top-bar {
        display: flex;
        gap: 10px;
        background: #fff;
        padding: 12px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
      }
      input[type="text"] {
        flex: 1;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccd3df;
      }
      button {
        padding: 10px 18px;
        background: #1f73b7;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
      }
      button:hover {
        background: #155a8a;
      }

      .masjid {
        background: white;
        padding: 18px;
        border-radius: 10px;
        margin-bottom: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        animation: fadeIn 0.3s ease;
      }
      .masjid h3 {
        margin: 0;
        color: #0f3d5e;
      }

      .timing-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 12px;
        background: #eef5ff;
        border-radius: 8px;
        border-left: 4px solid #1e6ab3;
        margin-top: 12px;
        font-size: 14px;
      }
      .timing-item {
        flex: 1;
        font-weight: 500;
        min-width: 120px;
      }

      .update-box {
        margin-top: 12px;
        padding: 15px;
        background: #fafcff;
        border: 1px solid #e3e8f0;
        border-radius: 8px;
      }

      .form-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .form-row label {
        flex: 1;
        font-size: 14px;
        font-weight: bold;
      }
      .form-row input {
        width: 100%;
        padding: 6px;
        border-radius: 6px;
        border: 1px solid #c7ccd6;
        margin-top: 4px;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>

  <body>
    <h1>Masjid Timings</h1>

    <!-- SEARCH BAR -->
    <div class="top-bar">
      <input
        type="text"
        id="search"
        placeholder="Search masjid..."
        onkeyup="searchMasjids()"
      />
      <button onclick="loadMasjids()">Refresh</button>
    </div>

    <div id="list"></div>

    <script>
      const API_BASE = "http://localhost:8080/api/v1";
      let allMasjids = [];

      // AUTO LOAD
      window.onload = loadMasjids;

      // LOAD ALL MASJIDS
      async function loadMasjids() {
        const resp = await fetch(`${API_BASE}/masjids/getall`);
        allMasjids = await resp.json();
        renderMasjidList(allMasjids);
      }

      // SEARCH BY NAME (backend search)
      async function searchMasjids() {
        const q = document.getElementById("search").value;

        if (q.trim() === "") {
          renderMasjidList(allMasjids);
          return;
        }

        const resp = await fetch(`${API_BASE}/masjids?name=${q}`);
        const result = await resp.json();
        renderMasjidList(result);
      }

      // RENDER MASJID LIST
      function renderMasjidList(arr) {
        const list = document.getElementById("list");
        list.innerHTML = "";

        if (arr.length === 0) {
          list.innerHTML = "<p>No masjids found</p>";
          return;
        }

        arr.forEach((m) => {
          const d = document.createElement("div");
          d.className = "masjid";

          d.innerHTML = `
            <h3>${m.name}</h3>
            <div>${m.address ?? ""}</div>
            <br/>
            <button onclick="showTimings(${m.id})">Show Timings</button>
            <button onclick="showUpdateForm(${m.id})">Update Timing</button>

            <div id="timings-${m.id}"></div>
            <div id="form-${m.id}"></div>
        `;

          list.appendChild(d);
        });
      }

      // SHOW TIMINGS
      async function showTimings(id) {
        const panel = document.getElementById(`timings-${id}`);
        const resp = await fetch(`${API_BASE}/masjids/${id}/timings`);
        const arr = await resp.json();

        if (arr.length === 0) {
          panel.innerHTML = "<p>No timings available</p>";
          return;
        }

        panel.innerHTML = arr
          .map(
            (t) => `
        <div class="timing-row">
            <div class="timing-item"><strong>Date:</strong> ${t.date}</div>
            <div class="timing-item"><strong>Fajr:</strong> ${t.fajr}</div>
            <div class="timing-item"><strong>Sunrise:</strong> ${t.sunrise}</div>
            <div class="timing-item"><strong>Dhuhr:</strong> ${t.dhuhr}</div>
            <div class="timing-item"><strong>Asr:</strong> ${t.asr}</div>
            <div class="timing-item"><strong>Maghrib:</strong> ${t.maghrib}</div>
            <div class="timing-item"><strong>Isha:</strong> ${t.isha}</div>
        </div>
    `
          )
          .join("");
      }

      // UPDATE FORM
      function showUpdateForm(id) {
        const el = document.getElementById(`form-${id}`);

        el.innerHTML = `
        <div class="update-box">
            <h4>Update Namaz Timings</h4>

            <div class="form-row">
                <label>Date
                    <input id="date-${id}" type="date">
                </label>
                <label>Fajr
                    <input id="fajr-${id}" type="time">
                </label>
                <label>Sunrise
                    <input id="sunrise-${id}" type="time">
                </label>
                <label>Dhuhr
                    <input id="dhuhr-${id}" type="time">
                </label>
                <label>Asr
                    <input id="asr-${id}" type="time">
                </label>
                <label>Maghrib
                    <input id="maghrib-${id}" type="time">
                </label>
                <label>Isha
                    <input id="isha-${id}" type="time">
                </label>
            </div>

            <button onclick="submitTiming(${id})">Submit</button>
            <div id="msg-${id}" style="margin-top:6px;color:green;"></div>
        </div>
    `;
      }

      // SUBMIT TIMINGS
      async function submitTiming(id) {
        const body = {
          date: document.getElementById(`date-${id}`).value,
          fajr: document.getElementById(`fajr-${id}`).value,
          sunrise: document.getElementById(`sunrise-${id}`).value,
          dhuhr: document.getElementById(`dhuhr-${id}`).value,
          asr: document.getElementById(`asr-${id}`).value,
          maghrib: document.getElementById(`maghrib-${id}`).value,
          isha: document.getElementById(`isha-${id}`).value,
        };

        const resp = await fetch(`${API_BASE}/masjids/${id}/timings`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        const msg = document.getElementById(`msg-${id}`);

        if (resp.ok) {
          msg.textContent = "Timings updated!";
          msg.style.color = "green";
          showTimings(id);
        } else {
          msg.textContent = "Error updating!";
          msg.style.color = "red";
        }
      }
    </script>
  </body>
</html>
